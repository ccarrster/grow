<!DOCTYPE html>
<html>
<body>
<script src="jquery-3.3.1.min.js"></script>
<script>

hexIndex = 0;

class hex{
	constructor(){
		this.sides = [null, null, null, null, null, null];
		this.score = 1;
		this.piece = null;
		this.visited = false;
		this.range = null;
		this.indexMap = hexIndex++;
		this.activated = false;
	}
}

class piece{
	constructor(){
		this.player = null;
		this.size = 0;
	}
}

class player{
	constructor(){
		this.energy = 0;
		this.score = 0;
	}
}

var scores = [
[14, 14, 13, 13, 13, 12, 12, 12, 12],
[17, 16, 16, 14, 14, 13, 13, 13],
[19, 18, 18, 17, 17],
[22, 21, 20]
];

var sunMoves = 0;

var sunnySide = 0;

var players = [];

function moveSun(){
	sunnySide += 1;
	if(sunnySide == 6){
		sunnySide = 0;
	}
	sunMoves += 1;
}

function finalScore(player){
	if(players[player] !== null){
		return player.score + Math.floor(player.energy / 3);
	} else {
		return null;
	}
}

var countPlayer = 0;
var playerCount = 0;

function treeCount(currentHex){
	if(currentHex.piece != null){
		if(currentHex.piece.player === countPlayer){
			playerCount += 1;
		}
	}
}


var selectedPlayer = null;
var treeList = null;
function getTreeList(currentHex){
	if(currentHex.piece != null){
		if(currentHex.piece.player === selectedPlayer){
			if(currentHex.piece.size > 0){
				treeList.push(currentHex.indexMap);
			}
		}
	}
}

function getTreeAndSeedList(currentHex){
	if(currentHex.piece != null){
		if(currentHex.piece.player === selectedPlayer){
			treeList.push(currentHex.indexMap);
		}
	}
}

var firstTreeList = null;
function getFirstTreeList(currentHex){
	if(currentHex.piece === null && currentHex.score == 1){
		firstTreeList.push(currentHex.indexMap);
	}
}

function getScore(hexScore){
	var scoreIndex = hexScore - 1;
	while(scoreIndex >= 0){
		if(scores[scoreIndex].length > 0){
			return scores[scoreIndex].shift();
		} else {
			scoreIndex -= 1;
		}
	}
	return 0;
}

function grow(currentHex){
	if(currentHex.piece.size < 3){
		currentHex.piece.size += 1;
	} else {
		var hexScore = currentHex.score;
		players[currentHex.piece.player].score += getScore(hexScore);
		currentHex.piece = null;
	}
}

function absorb(currentHex){
	var player = null;
	var potentialEnergy = 0;
	if(currentHex.piece !== null){
		player = currentHex.piece.player;
		if(currentHex.piece.size != 0){
			potentialEnergy = currentHex.piece.size;
		}
		var blockingSide = opositeSide(sunnySide);
		for(var i = 0; i < 3; i++){
			blockingHex = currentHex.sides[blockingSide];
			if(blockingHex != null){
				if(blockingHex.piece != null){
					if(blockingHex.piece.size > i && blockingHex.piece.size >= potentialEnergy){
						potentialEnergy = 0;
					}
				}
			} else {
				break;
			}
		}
	}
	if(player !== null && potentialEnergy !== 0){
		players[player].energy += potentialEnergy;
	}
}

function opositeSide(side){
	result = (side + 3);
	if(result > 5){
		result = result - 6;
	}
	return result;
}

function join(a, b, aSideNum){
	var otherNumber = opositeSide(aSideNum);
	if(a.sides[aSideNum] === null && b.sides[otherNumber] === null){
		a.sides[aSideNum] = b;
		b.sides[otherNumber] = a;
	} else {
		console.log("Can not join");
	}
}

function logIt(currentHex){
	console.log(currentHex);
}

var hexCount = 0;
function countIt(currentHex){
	hexCount += 1;
}

var traverseCount = 0;
function traverse(a, callbackFunction){
	traverseCount += 1;
	a.visited = true;
	callbackFunction(a);
	for(var traverseIndex = 0; traverseIndex < a.sides.length; traverseIndex++){
		if(a.sides[traverseIndex] !== null && a.sides[traverseIndex].visited !== true){
			traverse(a.sides[traverseIndex], callbackFunction);
		}
	}
}

function range(currentHex){
	for(var j = 0; j < currentHex.sides.length; j++){
		if(currentHex.sides[j] !== null){
			if(currentHex.sides[j].range === null){
				currentHex.sides[j].range = (currentHex.range + 1);
				$("#hex"+currentHex.sides[j].indexMap).html((currentHex.range + 1));
			} else if((currentHex.range + 1) < currentHex.sides[j].range){
				currentHex.sides[j].range = (currentHex.range + 1);
				currentHex.visted = false;
				currentHex.sides[j].visited = false;
				$("#hex"+currentHex.sides[j].indexMap).html((currentHex.range + 1));
			}
		}
	}
}

function resetRange(a){
	a.range = null;
}

var rangeMax = null;
var rangeList = [];
function getRangeList(currentHex){
	if(currentHex.range > 0 && currentHex.range <= rangeMax){
		rangeList.push(currentHex.indexMap);
	}
}

function clean(a){
	a.visited = false;
	for(var i = 0; i < a.sides.length; i++){
		if(a.sides[i] !== null && a.sides[i].visited !== false){
			clean(a.sides[i]);
		}
	}
}

function addRow(a, counter){
	for(var i = 0; i < counter; i++){
		var b = new hex();
		join(a, b, 3);
		a = b;
	}
}

function joinRowSmallBig(rowA, rowB){
	while(rowA !== null){
		join(rowA, rowB, 1);
		rowB = rowB.sides[3];
		join(rowA, rowB, 2);
		rowA = rowA.sides[3];
	}
}

function joinRowBigSmall(rowA, rowB){
	while(rowB !== null){
		join(rowA, rowB, 2);
		rowA = rowA.sides[3];
		join(rowA, rowB, 1);
		rowB = rowB.sides[3];
	}
}

var root = new hex();
addRow(root, 3);
var newHex = new hex();
addRow(newHex, 4);
joinRowSmallBig(root, newHex);
var newHex2 = new hex();
addRow(newHex2, 5);
joinRowSmallBig(newHex, newHex2);
var newHex3 = new hex();
addRow(newHex3, 6);
joinRowSmallBig(newHex2, newHex3);
var newHex4 = new hex();
addRow(newHex4, 5);
joinRowBigSmall(newHex3, newHex4);
var newHex5 = new hex();
addRow(newHex5, 4);
joinRowBigSmall(newHex4, newHex5);
var newHex6 = new hex();
addRow(newHex6, 3);
joinRowBigSmall(newHex5, newHex6);

function setScore(currentHex){
	var minDepth = 8;
	for(var sideKey in currentHex.sides){
		var workingHex = currentHex;
		var sideCount = 0;
		while(workingHex != null){
			workingHex = workingHex.sides[sideKey];
			sideCount += 1;
		}
		if(sideCount < minDepth){
			minDepth = sideCount;
		}
	}
	currentHex.score = minDepth;
}

traverse(root, setScore)
clean(root);

/*
root.range = 0;
traverse(root, range);
clean(root);

traverse(root, resetRange);
clean(root);

countPlayer = 0;
playerCount = 0;
traverse(root, treeCount);
clean(root);
*/

var selectedHex = null;
var indexMap = null;
function getHexByIndexMap(index){
	selectedHex = null;
	indexMap = index;
	traverse(root, selectHex);
	clean(root);
	return selectedHex;
}

function selectHex(currentHex){
	if(currentHex.indexMap === indexMap){
		selectedHex = currentHex;
	}
}


</script>

<div id="grid" style="position:relative; background-color: black;">
</div>
<script>
var startX = 10;
var startY = 10;
var size = 50;
var offsetX = size + 10;
var offsetY = size + 10;

$("#grid").css("height",7 * offsetY + 10 + "px");
$("#grid").css("width",7 * offsetX + 10 + "px");

var column = 0;

var indexMap = 0;

function getHexColor(indexMap){
	var currentHex = getHexByIndexMap(indexMap);
	if(currentHex.score == 1){
		return "#B8860B";
	} else if(currentHex.score == 2){
		return "#556B2F";
	} else if(currentHex.score == 3){
		return "#008000";
	} else if(currentHex.score == 4){
		return "#006400";
	}
}

function getPieceImage(indexMap){
	var currentHex = getHexByIndexMap(indexMap);
	if(currentHex.piece !== null){
		var size = "";
		if(currentHex.piece.size == 1){
			size = "small";
		} else if(currentHex.piece.size == 2){
			size = "medium";
		} else if(currentHex.piece.size == 3){
			size = "large";
		} else if(currentHex.piece.size == 0){
			size = "seed";
		}
		var color = "";
		if(currentHex.piece.player == 0){
			color = "red";
		} else if(currentHex.piece.player == 1){
			color = "green";
		} else if(currentHex.piece.player == 2){
			color = "blue";
		} else if(currentHex.piece.player == 3){
			color = "orange";
		}
		return color + size + ".png";
	} else {
		return "blank.png";
	}
}


var plantSeedFromTree = null;

function clickHex(hexIndex){
	if(selectMode === "grow"){
		growIndex(hexIndex);
		$("#grid button").prop('disabled', true);
		$("#grid div").css("opacity", "0.4");
		selectMode = "default";
	} else if(selectMode === "seedTree"){
		plantSeedFromTree = hexIndex;
		var seedTreeHex = getHexByIndexMap(hexIndex);
		selectMode = "plantSeed";
		seedTreeHex.range = 0;
		traverse(seedTreeHex, range);
		clean(root);
		rangeMax = seedTreeHex.piece.size;
		rangeList = [];
		traverse(root, getRangeList);
		clean(root);
		$("#grid button").prop('disabled', true);
		$("#grid div").css("opacity", "0.4");
		for(var rangeListKey in rangeList){
			var seedableIndex = rangeList[rangeListKey];
			var seedPotentialHex = getHexByIndexMap(seedableIndex);
			if(seedPotentialHex.piece === null){
				$("#hexwrap"+seedableIndex).css("opacity", "1.0");
				$("#hex"+seedableIndex).prop('disabled', false);
			}
		}
		traverse(root, resetRange);
		clean(root);
	} else if(selectMode === "plantSeed"){
		plantIndex(hexIndex);
		$("#grid button").prop('disabled', true);
		$("#grid div").css("opacity", "0.4");
		selectMode = "default";
	} else if(selectMode === "firstTree"){
		var newTreePiece = new piece();
		newTreePiece.size = 1;
		newTreePiece.player = $("#playerselect").val();
		var seedTreeHex = getHexByIndexMap(hexIndex);
		seedTreeHex.piece = newTreePiece;
		updateImage(hexIndex);
		seedTreeHex.activated = true;
		$("#grid button").prop('disabled', true);
		$("#grid div").css("opacity", "0.4");
		selectMode = "default";
		if(playerTurnIndex < players.length - 1){
			playerTurnIndex += 1;
			$("#playerselect").val(playerTurnIndex);
			plantFirstTree();
		} else if(firstTreeLoop === 0) {
			firstTreeLoop = 1;
			playerTurnIndex = 0;
			$("#playerselect").val(playerTurnIndex);
			plantFirstTree();
		} else {
			setAbsorb();
			//Buy seed/grow/harvest/pass loop (Activated, spend energy)
			//clear activated
			//Next players
			//move sun(end of game?)
			//Loop
		}
	}
}

var firstTreeLoop = 0;



function growIndex(hexIndex){
	var currentHex = getHexByIndexMap(hexIndex);
	if(currentHex.piece !== null){
		grow(currentHex);
		updateImage(hexIndex);
		currentHex.activated = true;
	} else {
		console.log("Can not grow no piece, should not happen.");
	}
}

function plantIndex(hexIndex){
	var currentHex = getHexByIndexMap(hexIndex);
	var dropPlayer = $("#playerselect").val();
	var seedPiece = new piece();
	seedPiece.player = dropPlayer;
	currentHex.piece = seedPiece;
	updateImage(hexIndex);
	currentHex.activated = true;
}

function updateImage(hexIndex){
	$("#hex"+hexIndex).css("background", "url("+getPieceImage(hexIndex)+")");
}

for(var rowIndex = 0; rowIndex < 4; rowIndex++){
	$("#grid").append('<div id="hexwrap'+(indexMap)+'" style="position:absolute;  top:'+(startY + (offsetY * 1.5) + offsetY * rowIndex)+'px; left:'+ (startX + offsetX * column) +'px; width: '+size+'px; height: '+size+'px; background-color:'+getHexColor(indexMap)+';"><button id="hex'+(indexMap)+'" style="width:'+size+'px; height:'+size+'px; background: url('+getPieceImage(indexMap)+');" onclick="clickHex('+(indexMap)+');"></div>');
	indexMap += 1;
}
column += 1;
for(var rowIndex = 0; rowIndex < 5; rowIndex++){
	$("#grid").append('<div id="hexwrap'+(indexMap)+'" style="position:absolute;  top:'+(startY + (offsetY * 1) + offsetY * rowIndex)+'px; left:'+ (startX + offsetX * column) +'px; width: '+size+'px; height: '+size+'px; background-color:'+getHexColor(indexMap)+';"><button id="hex'+(indexMap)+'" style="width:'+size+'px; height:'+size+'px; background: url('+getPieceImage(indexMap)+');" onclick="clickHex('+(indexMap)+');"></div>');
	indexMap += 1;
}
column += 1;
for(var rowIndex = 0; rowIndex < 6; rowIndex++){
	$("#grid").append('<div id="hexwrap'+(indexMap)+'" style="position:absolute;  top:'+(startY + (offsetY * 0.5) + offsetY * rowIndex)+'px; left:'+ (startX + offsetX * column) +'px; width: '+size+'px; height: '+size+'px; background-color:'+getHexColor(indexMap)+';"><button id="hex'+(indexMap)+'" style="width:'+size+'px; height:'+size+'px; background: url('+getPieceImage(indexMap)+');" onclick="clickHex('+(indexMap)+');"></div>');
	indexMap += 1;
}
column += 1;
for(var rowIndex = 0; rowIndex < 7; rowIndex++){
	$("#grid").append('<div id="hexwrap'+(indexMap)+'" style="position:absolute;  top:'+(startY + (offsetY * 0) + offsetY * rowIndex)+'px; left:'+ (startX + offsetX * column) +'px; width: '+size+'px; height: '+size+'px; background-color:'+getHexColor(indexMap)+';"><button id="hex'+(indexMap)+'" style="width:'+size+'px; height:'+size+'px; background: url('+getPieceImage(indexMap)+');" onclick="clickHex('+(indexMap)+');"></div>');
	indexMap += 1;
}
column += 1;
for(var rowIndex = 0; rowIndex < 6; rowIndex++){
	$("#grid").append('<div id="hexwrap'+(indexMap)+'" style="position:absolute;  top:'+(startY + (offsetY * 0.5) + offsetY * rowIndex)+'px; left:'+ (startX + offsetX * column) +'px; width: '+size+'px; height: '+size+'px; background-color:'+getHexColor(indexMap)+';"><button id="hex'+(indexMap)+'" style="width:'+size+'px; height:'+size+'px; background: url('+getPieceImage(indexMap)+');" onclick="clickHex('+(indexMap)+');"></div>');
	indexMap += 1;
}
column += 1;
for(var rowIndex = 0; rowIndex < 5; rowIndex++){
	$("#grid").append('<div id="hexwrap'+(indexMap)+'" style="position:absolute;  top:'+(startY + (offsetY * 1) + offsetY * rowIndex)+'px; left:'+ (startX + offsetX * column) +'px; width: '+size+'px; height: '+size+'px; background-color:'+getHexColor(indexMap)+';"><button id="hex'+(indexMap)+'" style="width:'+size+'px; height:'+size+'px; background: url('+getPieceImage(indexMap)+');" onclick="clickHex('+(indexMap)+');"></div>');
	indexMap += 1;
}
column += 1;
for(var rowIndex = 0; rowIndex < 4; rowIndex++){
	$("#grid").append('<div id="hexwrap'+(indexMap)+'" style="position:absolute;  top:'+(startY + (offsetY * 1.5) + offsetY * rowIndex)+'px; left:'+ (startX + offsetX * column) +'px; width: '+size+'px; height: '+size+'px; background-color:'+getHexColor(indexMap)+';"><button id="hex'+(indexMap)+'" style="width:'+size+'px; height:'+size+'px; background: url('+getPieceImage(indexMap)+');" onclick="clickHex('+(indexMap)+');"></div>');
	indexMap += 1;
}
var selectMode = "grow";

function selectTreeToSeed(){
	selectMode = "seedTree";
	selectedPlayer = $("#playerselect").val();
	treeList = [];
	traverse(root, getTreeList);
	clean(root);
	$("#grid button").prop('disabled', true);
	$("#grid div").css("opacity", "0.4");
	for(var treeListKey in treeList){
		var treeIndex = treeList[treeListKey];
		$("#hexwrap"+treeIndex).css("opacity", "1.0");
		$("#hex"+treeIndex).prop('disabled', false);
	}
}

function plantFirstTree(){
	selectMode = "firstTree";
	$("#grid button").prop('disabled', true);
	$("#grid div").css("opacity", "0.4");
	firstTreeList = [];
	traverse(root, getFirstTreeList);
	clean(root);
	for(var firstTreeListKey in firstTreeList){
		var validFirstTreeIndex = firstTreeList[firstTreeListKey];
		$("#hexwrap"+validFirstTreeIndex).css("opacity", "1.0");
		$("#hex"+validFirstTreeIndex).prop('disabled', false);
	}
}

function growTrees(){
	selectMode = "grow";
	selectedPlayer = $("#playerselect").val();
	treeList = [];
	traverse(root, getTreeAndSeedList);
	clean(root);
	$("#grid button").prop('disabled', true);
	$("#grid div").css("opacity", "0.4");
	for(var treeListKey in treeList){
		var treeIndex = treeList[treeListKey];
		$("#hexwrap"+treeIndex).css("opacity", "1.0");
		$("#hex"+treeIndex).prop('disabled', false);
	}
}

var playerTurnIndex = 0;

function start(numPlayers){
	if(numPlayers >= 1){
		$("#playerselect").append('<option value="0">Red</option>');
		players.push(new player());
	}
	if(numPlayers >= 2){
		$("#playerselect").append('<option value="1">Green</option>');
		players.push(new player());
	}
	if(numPlayers >= 3){
		$("#playerselect").append('<option value="2">Blue</option>');
		players.push(new player());
	}
	if(numPlayers >= 4){
		$("#playerselect").append('<option value="3">Orange</option>');
		players.push(new player());
	}
	$("#playerselect").val(playerTurnIndex);
	plantFirstTree();
}

function setAbsorb(){
	traverse(root, absorb);
	clean(root);
	var energyDetailsString = "";
	if(players.length >= 1){
		energyDetailsString += "<div>Player Red Energy: "+players[0].energy+" Score: "+players[0].score+"</div>";
	}
	if(players.length >= 2){
		energyDetailsString += "<div>Player Green Energy: "+players[1].energy+" Score: "+players[1].score+"</div>";
	}
	if(players.length >= 3){
		energyDetailsString += "<div>Player Blue Energy: "+players[2].energy+" Score: "+players[2].score+"</div>";
	}
	if(players.length >= 4){
		energyDetailsString += "<div>Player Orange Energy: "+players[3].energy+" Score: "+players[3].score+"</div>";
	}
	$("#energydetails").html(energyDetailsString);



}

</script>
<div>
Player<select id="playerselect"></select>
<div id="sundetails"></div>
<button onclick='moveSun(); $("#sundetails").html("Sunny Side: "+sunnySide+" Sun Moves: "+sunMoves);'>Advance Sun</button>
<div id="energydetails"></div>
<button onclick='traverse(root, absorb); clean(root); $("#energydetails").html("<div>Player Red Energy: "+players[0].energy+" Score: "+players[0].score+"</div><div>Player Green Energy: "+players[1].energy+" Score: "+players[1].score+"</div><div>Player Blue Energy: "+players[2].energy+" Score: "+players[2].score+"</div><div>Player Orange Energy: "+players[3].energy+" Score: "+players[3].score+"</div>")'>Absorb Energy</button>
<button onclick='selectTreeToSeed()'>Select Tree to Seed</button>
<button onclick='plantFirstTree()'>Plant First Tree</button>
<button onclick='growTrees()'>Grow Trees</button>
<button onclick='start(4)'>4 Players</button>
<button onclick='start(3)'>3 Players</button>
<button onclick='start(2)'>2 Players</button>
<button onclick='start(1)'>1 Player</button>
</div>

</body>
</html>